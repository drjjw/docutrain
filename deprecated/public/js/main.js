// âš ï¸ DEPRECATED: This file is deprecated and no longer used.
// The application has been migrated to React/TypeScript.
// Active implementation: app-src/src/main.tsx
// DO NOT EDIT THIS FILE - Use React app instead.

// Main initialization and event wiring
// This is a thin orchestrator that imports functionality from specialized modules

import { API_URL, generateSessionId } from './config.js';
import { sendMessage, setupScrollInterruptDetection, resetAutoScroll } from './chat.js';
import { submitRating } from './rating.js';
import { debugLog } from './debug-logger.js';
import { initializeMobileKeyboardSupport } from './mobile-keyboard.js';
import { initializeMobileHeaderBehavior } from './mobile-header.js';
import { initializePage } from './page-loader.js';

// Detect if running from source or built files
function detectRunningMode() {
    // Get script source - find main.js script tag (most reliable for ES modules)
    let currentScriptSrc = '';
    
    // Find main.js script tag in the DOM
    const mainScript = Array.from(document.querySelectorAll('script[src]'))
        .find(s => s.src.includes('main.js'));
    
    if (mainScript) {
        currentScriptSrc = mainScript.src;
    }
    
    // Fallback to document.currentScript (works in regular scripts, but null in ES modules)
    if (!currentScriptSrc && document.currentScript) {
        currentScriptSrc = document.currentScript.src;
    }
    
    // Check if current script has hash (built version)
    const hasHash = /[a-f0-9]{8,}\.js$/i.test(currentScriptSrc);
    
    // Check URL path for dist/public indicators
    const urlPath = window.location.pathname;
    const isDistPath = urlPath.includes('/dist/') || urlPath.includes('dist/public/');
    
    // Check all scripts for hashed files (additional indicator)
    const allScripts = Array.from(document.querySelectorAll('script[src]'));
    const hasHashedFiles = allScripts.some(s => {
        const src = s.getAttribute('src') || s.src || '';
        // Built files have pattern like: main.{hash}.js or in dist folder
        return /[a-f0-9]{8,}\.js$/i.test(src) || src.includes('/dist/');
    });
    
    const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
    
    let mode;
    if (hasHash || hasHashedFiles || isDistPath || currentScriptSrc.includes('/dist/')) {
        mode = 'BUILT (dist/public/)';
    } else if (currentScriptSrc.includes('/public/js/main.js') || 
               (!currentScriptSrc.includes('/dist/') && !isDistPath)) {
        mode = 'SOURCE (public/)';
    } else {
        mode = 'UNKNOWN';
    }
    
    console.log('\n' + '='.repeat(60));
    console.log(`ðŸ“± CHAT APP - Running Mode: ${mode}`);
    console.log(`ðŸ“ Script source: ${currentScriptSrc || 'Not found'}`);
    console.log(`ðŸ”— Current URL: ${window.location.href}`);
    console.log(`ðŸŒ Port: ${port}`);
    console.log(`ðŸ—ï¸  Hashed files detected: ${hasHash || hasHashedFiles ? 'âœ… Yes' : 'âŒ No'}`);
    console.log('='.repeat(60) + '\n');
    
    return mode;
}

// Log running mode on startup
// Use setTimeout to ensure all script tags are in the DOM
setTimeout(() => {
    detectRunningMode();
}, 0);

// Export debug logger for backward compatibility
export { DEBUG_LEVEL, DEBUG_LEVELS, debugLog } from './debug-logger.js';

// Configure marked for better formatting
marked.setOptions({
    breaks: false, // Prevent awkward line breaks in lists
    gfm: true
});

// Application state (RAG-only mode)
const state = {
    conversationHistory: [],
    isLoading: false,
    selectedModel: 'grok',
    sessionId: generateSessionId(),
    selectedDocument: 'smh', // Default to SMH (can be string or array for multi-doc)
    selectedDocuments: ['smh'], // Array of selected documents
    isLocalEnv: false
};

// DOM elements
const elements = {
    chatContainer: document.getElementById('chatContainer'),
    messageInput: document.getElementById('messageInput'),
    sendButton: document.getElementById('sendButton')
};

// Initialize mobile keyboard support
initializeMobileKeyboardSupport(elements);

// Initialize mobile header behavior
initializeMobileHeaderBehavior();

// Initialize scroll interrupt detection for smart auto-scrolling
if (elements.chatContainer) {
    setupScrollInterruptDetection(elements.chatContainer);
    elements.chatContainer.setAttribute('data-scroll-detection-setup', 'true');
    console.log('ðŸ“œ Smart auto-scroll initialized');
}

console.log('ðŸ” URL Detection:');
console.log('  - Current path:', window.location.pathname);
console.log('  - API Base URL:', API_URL);
console.log('  - Health endpoint:', `${API_URL}/api/health`);

// Event listeners for chat
elements.sendButton.addEventListener('click', () => {
    resetAutoScroll(); // User is sending a message, they're ready for new content
    sendMessage(state, elements);
});

elements.messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        resetAutoScroll(); // User is sending a message, they're ready for new content
        sendMessage(state, elements);
    }
});

// Expose submitRating to window for rating button clicks
window.submitRating = submitRating;

// Initialize page (async to ensure document is loaded before health check)
(async () => {
    await initializePage(state, elements);
})();
