# UKidney Manual Assistant - Proxy to Node.js
RewriteEngine On

# First, force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Then, redirect non-www to www (with HTTPS)
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteRule ^(.*)$ https://www.%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Don't proxy if directly accessing these (would create loops)
RewriteCond %{REQUEST_URI} !^/\.well-known/

# Proxy everything to Node.js on port 3458
RewriteRule ^(.*)$ http://127.0.0.1:3458/$1 [P,L,QSA]

# CORS Headers
<IfModule mod_headers.c>
    Header set Access-Control-Allow-Origin "*"
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type"
</IfModule>

# Security
<FilesMatch "^(\.env|server\.js|package.*|\.git)">
    Require all denied
</FilesMatch>
