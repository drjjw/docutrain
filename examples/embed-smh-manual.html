<script src="/content/pdf/core/lib/webviewer.min.js" type="text/javascript"></script>

<!-- Hero Section -->
<div class="uk-section uk-section-default" style="background: #ffffff; padding-top: 40px; padding-bottom: 40px;">
	<div class="uk-container uk-container-large">
		<div class="uk-grid uk-grid-large uk-flex-middle" data-uk-grid>
			<div class="uk-width-3-5@m uk-width-1-1@s">
				<div style="position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">
					<img src="https://ukidney.com/images/ukidney-ai-guidelines.webp" alt="SMH Nephrology Manual - AI Powered" style="width: 100%; height: auto; display: block;" />
					<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0, 0, 0, 0.75) 0%, rgba(0, 0, 0, 0.4) 50%, transparent 100%); padding: 40px 32px 32px; color: white;">
						<h2 style="margin: 0; font-size: 32px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px; line-height: 1.2; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);">SMH Nephrology Housestaff Manual</h2>
					</div>
				</div>
			</div>
			<div class="uk-width-2-5@m uk-width-1-1@s">
				<div>
					<h2 style="font-size: 36px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px; line-height: 1.2; margin-bottom: 24px;">AI-Powered Manual Access</h2>
					<p style="margin-bottom: 16px; line-height: 1.6;">
						Access the St. Michael's Hospital Nephrology Housestaff Manual through our AI-powered assistant. Ask questions in natural language to get instant answers sourced directly from the manual content.
					</p>
					<p style="margin-bottom: 16px; line-height: 1.6;">
						Our assistant helps you find specific recommendations, protocols, and information without navigating lengthy PDFs. Whether you need treatment guidelines, diagnostic criteria, or management strategies, get evidence-based answers quickly.
					</p>
					<p style="margin-bottom: 0; line-height: 1.6;">
						Simply ask your question in plain language, and the AI assistant will search through the complete manual to provide accurate, contextually relevant information with source references.
					</p>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Main Content Section -->
<div class="uk-section uk-section-default">
	<div class="uk-container uk-container-large">
		<div class="uk-card uk-card-default uk-card-body" style="border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); background: #ffffff;">
			
			<!-- Primary AI Option - Centered -->
			<div class="uk-margin-large-bottom" style="margin-bottom: 48px;">
				<div class="ai-primary-card">
					<div style="position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, #cc0000 0%, #e63946 100%);"></div>
					<div class="ai-primary-content">
						<div class="ai-primary-icon">
							<i class="fa-solid fa-message"></i>
						</div>
						<h3 style="font-weight: 700; color: #1a1a1a; font-size: 32px; letter-spacing: -0.3px; text-align: center; margin-bottom: 16px;">Chat with Manual (Powered by AI)</h3>
						<p style="font-size: 18px; color: #666; text-align: center; margin-bottom: 32px; max-width: 600px; margin-left: auto; margin-right: auto;">
							Ask questions with our AI assistant trained on the complete manual content. Get instant, evidence-based answers.
						</p>
						<button class="ai-primary-button" type="button" id="open-chat-button">
							<span style="display: flex; align-items: center; justify-content: center; gap: 12px;">
								<span>Open AI Assistant</span>
								<i class="fa-solid fa-arrow-right" style="font-size: 16px;"></i>
							</span>
						</button>
					</div>
				</div>
			</div>

			<!-- Secondary Options - PDF and Download -->
			<div class="uk-margin-large-top" style="margin-top: 48px; padding-top: 48px; border-top: 1px solid #e8e8e8;">
				<h4 class="uk-h4 uk-text-center" style="color: #666; font-weight: 500; font-size: 18px; margin-bottom: 32px;">Alternative Access Options</h4>
				<div class="uk-grid-match uk-child-width-1-2@m uk-child-width-1-1@s uk-margin-medium" data-uk-grid>
					<div>
						<div class="secondary-option-card">
							<div class="secondary-icon"><i class="fa-solid fa-book-open"></i></div>
							<h4 style="font-size: 20px; margin: 0 0 12px 0; color: #333; text-align: center;">View PDF</h4>
							<p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Read the full PDF manual in a viewer</p>
							<a href="#modal-full" class="secondary-button" uk-toggle>
								<i class="fa-solid fa-book-open"></i> Open PDF Viewer
							</a>
						</div>
					</div>
					<div>
						<div class="secondary-option-card">
							<div class="secondary-icon"><i class="fa-solid fa-download"></i></div>
							<h4 style="font-size: 20px; margin: 0 0 12px 0; color: #333; text-align: center;">Direct Download</h4>
							<p style="color: #666; margin-bottom: 20px; font-size: 14px; text-align: center;">Download the PDF file directly</p>
							<a href="https://ukidney.com/content/manuals/smh/SMH%20Nephrology%20Housestaff%20Manual-2023.pdf" target="_blank" rel="noopener" class="secondary-button">
								<i class="fa-solid fa-download"></i> Download PDF
							</a>
						</div>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>

<!-- PDF Modal -->
<div id="modal-full" class="uk-modal-container" uk-modal esc-close="true">
	<div class="uk-modal-dialog">
		<button type="button" class="uk-modal-close-full uk-close-large" uk-close></button>
		<div id="viewer" style="height: 100vh;"></div>
	</div>
</div>

<!-- Chat Modal -->
<div id="manual-assistant-modal" class="modern-modal-overlay">
	<div class="modern-modal-backdrop" onclick="closeChatModal()"></div>
	<div class="modern-modal-panel">
		<button class="modern-close-button" type="button" onclick="closeChatModal()" aria-label="Close chat">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
				<line x1="18" y1="6" x2="6" y2="18"></line>
				<line x1="6" y1="6" x2="18" y2="18"></line>
			</svg>
		</button>
		<div class="modern-modal-body">
		<iframe 
			id="chat-iframe"
				src="about:blank"
				class="modern-iframe"
			allow="clipboard-write"
			title="Chat Assistant">
		</iframe>
		</div>
	</div>
</div>

<!-- About Section -->
<div style="text-align: left; margin-top: 40px;">
	<div><strong>About this manual:</strong></div>
	<div>A nephrology housestaff manual intended for trainees rotating through St. Michael's Hospital.</div>
	<div>For Questions about this manual, please email <a href="mailto:jeffrey.zaltzman@utoronto.ca" target="_self">Dr. Jeffrey Zaltzman</a> (St. Michael's Hospital)</div>
	<div>See also: <a href="nephrology-publications/nephrology-manuals/university-health-network-nephrology-manual">University Health Network Nephrology Manual</a></div>
</div>

<script type="text/javascript">
	// Initialize PDF Viewer
	WebViewer({
		path: '/content/pdf/core/lib',
		licenseKey: '5sWIr8PdBc1Y2NPyyFtk',
		initialDoc: 'https://ukidney.com/content/manuals/smh/SMH%20Nephrology%20Housestaff%20Manual-2023.pdf',
	}, document.getElementById('viewer'))
	.then((instance) => {
		const { documentViewer, annotationManager } = instance.Core;
		instance.UI.setTheme('light');
	});

	// Chat Modal Functions
	let chatModalOpen = false;
	let isOpeningModal = false; // Guard to prevent multiple simultaneous calls
	const docUrl = 'https://www.docutrain.io/app/chat?doc=smh&footer=false';

	window.addEventListener('message', function(event) {
		// Verify origin for security
		if (event.origin !== 'https://www.docutrain.io') return;
		
		if (event.data.type === 'headerCollapsed') {
			// Could add parent-level handling here if needed
			console.log('Header collapsed state:', event.data.collapsed);
		}
	});

	// Initialize modal handlers - run immediately
	(function initModalHandlers() {
		function attachHandlers() {
			// Prevent closing when clicking inside the panel
			const modalPanel = document.querySelector('.modern-modal-panel');
			if (modalPanel) {
				modalPanel.addEventListener('click', function(e) {
					e.stopPropagation();
				});
			}
			
			// Add event listener to the chat button - use capture phase to catch early
			const chatButton = document.getElementById('open-chat-button');
			if (chatButton) {
				// Remove any existing handlers first by cloning
				const newButton = chatButton.cloneNode(false); // false = don't clone children/attributes
				// Copy the innerHTML
				newButton.innerHTML = chatButton.innerHTML;
				// Copy important attributes
				newButton.id = chatButton.id;
				newButton.className = chatButton.className;
				newButton.type = chatButton.type;
				chatButton.parentNode.replaceChild(newButton, chatButton);
				
				// Single unified handler for all pointer events (mouse, touch, pen)
				function handleButtonInteraction(e) {
					console.log('Button interaction:', e.type);
					e.preventDefault();
					e.stopPropagation();
					e.stopImmediatePropagation();
					openChatModal(e);
					return false;
				}
				
				// Handle all pointer event types the same way
				newButton.addEventListener('click', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('touchstart', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('touchend', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('pointerdown', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('pointerup', handleButtonInteraction, { capture: true, passive: false });
			}
		}
		
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', attachHandlers);
		} else {
			attachHandlers();
		}
	})();

	function openChatModal(event) {
		console.log('openChatModal called', event);
		
		// Prevent multiple simultaneous calls
		if (isOpeningModal || chatModalOpen) {
			console.log('Modal already opening or open, ignoring duplicate call');
			return false;
		}
		
		// Prevent any default behavior FIRST - be very aggressive
		if (event) {
			event.preventDefault();
			event.stopPropagation();
			event.stopImmediatePropagation();
		}
		
		// Also prevent window navigation
		if (window.event) {
			window.event.preventDefault();
			window.event.stopPropagation();
		}
		
		isOpeningModal = true;
		
		const modal = document.getElementById('manual-assistant-modal');
		const iframe = document.getElementById('chat-iframe');
		const body = document.body;
		
		if (!modal || !iframe) {
			console.error('Modal elements not found');
			isOpeningModal = false;
			return false;
		}
		
		console.log('Opening modal');
		
		// Show modal IMMEDIATELY - don't wait for iframe
		modal.style.display = 'block';
		modal.style.visibility = 'visible';
		modal.style.opacity = '1';
		modal.style.zIndex = '99999'; // Ensure it's on top
		body.classList.add('modern-modal-open');
		chatModalOpen = true;
		preventScroll();
		
		// Force modal to be visible immediately
		requestAnimationFrame(() => {
			modal.classList.add('active');
			// Double-check modal is visible
			if (modal.style.display !== 'block') {
				modal.style.display = 'block';
			}
			if (!modal.classList.contains('active')) {
				modal.classList.add('active');
			}
		});
		
		// Set iframe src AFTER modal is visible
		iframe.src = 'about:blank';
		
		// Use a tiny delay to ensure about:blank is set, then set the actual URL
		setTimeout(() => {
			iframe.src = docUrl;
			isOpeningModal = false; // Reset guard after modal is shown
			
			// Verify modal is actually visible
			setTimeout(() => {
				const computedStyle = window.getComputedStyle(modal);
				console.log('Modal visibility check:', {
					display: computedStyle.display,
					visibility: computedStyle.visibility,
					opacity: computedStyle.opacity,
					zIndex: computedStyle.zIndex,
					hasActiveClass: modal.classList.contains('active')
				});
				
				if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
					console.warn('Modal not visible! Forcing visibility...');
					modal.style.display = 'block';
					modal.style.visibility = 'visible';
					modal.style.opacity = '1';
					modal.classList.add('active');
				}
			}, 100);
		}, 10);
		
		return false;
	}

	function closeChatModal() {
		const modal = document.getElementById('manual-assistant-modal');
		const iframe = document.getElementById('chat-iframe');
		const body = document.body;
		
		modal.classList.remove('active');
		body.classList.remove('modern-modal-open');
		chatModalOpen = false;
		
		// Reset iframe and hide modal after transition completes
		setTimeout(() => {
			iframe.src = 'about:blank';
			modal.style.display = 'none'; // Hide after transition
		}, 400);
		
		allowScroll();
	}

	let scrollPosition = 0;
	
	function preventScroll() {
		scrollPosition = window.pageYOffset;
		document.body.style.overflow = 'hidden';
		document.body.style.position = 'fixed';
		document.body.style.top = `-${scrollPosition}px`;
		document.body.style.width = '100%';
	}
	
	function allowScroll() {
		document.body.style.overflow = '';
		document.body.style.position = '';
		document.body.style.top = '';
		document.body.style.width = '';
		window.scrollTo(0, scrollPosition);
	}

	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape' && chatModalOpen) {
			closeChatModal();
		}
	});
</script>

<style>
	/* Primary AI Card - Centered and Prominent */
	.ai-primary-card {
		background: #ffffff;
		border-radius: 12px;
		padding: 60px 40px;
		border: 1px solid #e0e0e0;
		position: relative;
		overflow: hidden;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
		max-width: 800px;
		margin: 0 auto;
	}

	.ai-primary-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 8px 24px rgba(204, 0, 0, 0.15) !important;
		border-color: #cc0000 !important;
	}

	.ai-primary-content {
		position: relative;
		z-index: 1;
	}

	.ai-primary-icon {
		font-size: 64px;
		color: #cc0000;
		margin-bottom: 24px;
		text-align: center;
	}

	.ai-primary-button {
		background: #cc0000;
		color: white;
		font-weight: 600;
		padding: 18px 40px;
		transition: all 0.2s ease;
		border: none;
		border-radius: 8px;
		font-size: 18px;
		text-align: center;
		width: 100%;
		max-width: 400px;
		margin: 0 auto;
		display: block;
		box-shadow: 0 2px 6px rgba(204, 0, 0, 0.2);
		cursor: pointer;
		text-decoration: none !important;
		pointer-events: auto;
	}

	.ai-primary-button:hover {
		opacity: 0.95;
		transform: translateX(3px);
		box-shadow: 0 4px 12px rgba(204, 0, 0, 0.35) !important;
	}

	.ai-primary-button:active {
		transform: translateX(1px);
		opacity: 0.9;
	}

	.ai-primary-button:focus {
		outline: none;
	}

	/* Secondary Option Cards - De-emphasized */
	.secondary-option-card {
		background: #f9f9f9;
		border: 1px solid #e5e5e5;
		border-radius: 12px;
		padding: 32px 24px;
		text-align: center;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
		height: 100%;
		display: flex;
		flex-direction: column;
		box-sizing: border-box;
		overflow: hidden;
	}

	.secondary-option-card:hover {
		border-color: #d0d0d0;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		transform: translateY(-2px);
	}

	.secondary-icon {
		font-size: 36px;
		color: #888;
		margin-bottom: 16px;
	}

	.secondary-button {
		background: #f5f5f5;
		color: #333;
		font-weight: 500;
		padding: 12px 24px;
		transition: all 0.2s ease;
		border: 1px solid #e0e0e0;
		border-radius: 8px;
		font-size: 14px;
		text-align: center;
		width: 100%;
		display: block;
		box-sizing: border-box;
		text-decoration: none !important;
		cursor: pointer;
		margin-top: auto;
		max-width: 100%;
	}

	.secondary-button:hover {
		background: #eeeeee;
		border-color: #cc0000;
		color: #cc0000;
		transform: translateY(-1px);
		box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
		text-decoration: none !important;
	}

	.secondary-button:active {
		transform: translateY(0);
	}

	/* Responsive adjustments */
	@media (max-width: 768px) {
		.ai-primary-card {
			padding: 40px 24px;
		}

		.ai-primary-icon {
			font-size: 48px;
		}

		.ai-primary-button {
			padding: 16px 32px;
			font-size: 16px;
		}

		.secondary-option-card {
			padding: 24px 20px;
		}
	}

	/* ===== PDF MODAL STYLES ===== */
	.uk-modal-close-full {
		bottom: 0 !important;
		left: 0;
		width: 50px;
		height: 50px;
		top: auto;
		z-index: 1000;
	}

	.uk-close {
		color: #ffffff;
		background: #cc0000 !important;
	}

	.uk-close:hover {
		color: pink;
	}

	.uk-modal-container {
		padding-top: 0;
	}

	.uk-modal.uk-open {
		overflow: hidden;
	}
	
	/* Prevent body scroll when UIKit modal is open */
	body.uk-modal-page {
		overflow: hidden;
	}

	/* Modern Modal Styles */
	.modern-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		width: 100%;
		height: 100%;
		z-index: 99999 !important; /* Ensure highest z-index */
		opacity: 0;
		visibility: hidden;
		pointer-events: none;
		display: none; /* Completely hidden on page load */
		/* No transition on initial load - only when opening */
		transition: none;
	}

	.modern-modal-overlay.active {
		display: block; /* Show when active */
		opacity: 1;
		visibility: visible;
		pointer-events: all;
		/* Enable transition only when active */
		transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.4s;
	}

	.modern-modal-backdrop {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.6);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
		opacity: 0;
		/* Transition enabled for closing animation */
		transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.modern-modal-overlay.active .modern-modal-backdrop {
		opacity: 1;
	}

	.modern-modal-panel {
		position: absolute;
		top: 0;
		right: 0;
		width: 100%;
		height: 100%;
		background: #ffffff;
		box-shadow: -8px 0 32px rgba(0, 0, 0, 0.15);
		display: flex;
		flex-direction: column;
		transform: translateX(100%);
		/* Transition enabled for closing animation */
		transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		overflow: hidden;
		position: relative;
	}

	.modern-modal-overlay.active .modern-modal-panel {
		transform: translateX(0);
		/* Enable transition only when active */
		transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.modern-close-button {
		position: absolute;
		top: 20px;
		right: 20px;
		width: 44px;
		height: 44px;
		background: rgba(255, 255, 255, 0.95);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		color: #333;
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		padding: 0;
		backdrop-filter: blur(10px);
		-webkit-backdrop-filter: blur(10px);
		z-index: 10000;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.modern-close-button:hover {
		background: rgba(255, 255, 255, 1);
		border-color: rgba(0, 0, 0, 0.2);
		transform: scale(1.05) rotate(90deg);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}

	.modern-close-button:active {
		transform: scale(0.95) rotate(90deg);
	}

	.modern-modal-body {
		flex: 1;
		overflow: hidden;
		position: relative;
		background: #ffffff;
	}

	.modern-iframe {
		width: 100%;
		height: 100%;
		border: none;
		display: block;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease 0.2s, visibility 0s 0.5s;
	}

	.modern-modal-overlay.active .modern-iframe {
		opacity: 1;
		visibility: visible;
		transition: opacity 0.3s ease 0.2s, visibility 0s 0s;
	}

	body.modern-modal-open {
		overflow: hidden;
	}

	/* Responsive Modal */
	@media (max-width: 768px) {
		.modern-close-button {
			top: 16px;
			right: 16px;
			width: 40px;
			height: 40px;
		}
	}
</style>