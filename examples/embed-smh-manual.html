
<script src="/content/pdf/core/lib/webviewer.min.js" type="text/javascript"></script>

<p style="text-align: left;"><span style="font-size: 12pt;"><strong><span>If you are having trouble viewing this resource or to download, please <a href="https://ukidney.com/content/manuals/smh/SMH%20Nephrology%20Housestaff%20Manual-2023.pdf" target="_blank" rel="noopener" class="">click here</a></span></strong></span></p>

<!-- Two Options Side by Side -->
<div class="manual-options">
	<div class="option-card">
		<div class="option-icon"><i class="fa-solid fa-book-open"></i></div>
		<h3>View Manual</h3>
		<p>Read the full PDF manual</p>
		<a href="#modal-full" class="uk-button uk-button-primary" uk-toggle>
			<i class="fa-solid fa-book-open"></i> Open PDF
		</a>
	</div>
	
	<div class="option-card">
		<div class="option-icon"><i class="fa-solid fa-message"></i></div>
		<h3>Chat with Manual (Powered by AI)</h3>
		<p>Ask questions with AI assistant</p>
		<button class="uk-button uk-button-primary" type="button" id="open-chat-button">
			<i class="fa-solid fa-message"></i> Open Chat
		</button>
	</div>
</div>

<!-- PDF Modal -->
<div id="modal-full" class="uk-modal-container" uk-modal esc-close="true">
	<div class="uk-modal-dialog">
		<button type="button" class="uk-modal-close-full uk-close-large" uk-close></button>
		<div id="viewer" style="height: 100vh;"></div>
	</div>
</div>

<!-- Chat Modal -->
<div id="manual-assistant-modal" class="modern-modal-overlay">
	<div class="modern-modal-backdrop" onclick="closeChatModal()"></div>
	<div class="modern-modal-panel">
		<button class="modern-close-button" type="button" onclick="closeChatModal()" aria-label="Close chat">
			<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
				<line x1="18" y1="6" x2="6" y2="18"></line>
				<line x1="6" y1="6" x2="18" y2="18"></line>
			</svg>
		</button>
		<div class="modern-modal-body">
		<iframe 
			id="chat-iframe"
				src="about:blank"
				class="modern-iframe"
			allow="clipboard-write"
			title="Chat Assistant">
		</iframe>
		</div>
	</div>
</div>

<!-- About Section -->
<div style="text-align: left; margin-top: 40px;">
	<div><strong>About this manual:</strong></div>
	<div>A nephrology housestaff manual intended for trainees rotating through St. Michael's Hospital.</div>
	<div>For Questions about this manual, please email <a href="mailto:jeffrey.zaltzman@utoronto.ca" target="_self">Dr. Jeffrey Zaltzman</a> (St. Michael's Hospital)</div>
	<div>See also: <a href="nephrology-publications/nephrology-manuals/university-health-network-nephrology-manual">University Health Network Nephrology Manual</a></div>
</div>

<script type="text/javascript">
	// Initialize PDF Viewer
	WebViewer({
		path: '/content/pdf/core/lib',
		licenseKey: '5sWIr8PdBc1Y2NPyyFtk',
		initialDoc: 'https://ukidney.com/content/manuals/smh/SMH%20Nephrology%20Housestaff%20Manual-2023.pdf',
	}, document.getElementById('viewer'))
	.then((instance) => {
		const { documentViewer, annotationManager } = instance.Core;
		instance.UI.setTheme('light');
	});

	// Chat Modal Functions
	let chatModalOpen = false;
	let isOpeningModal = false; // Guard to prevent multiple simultaneous calls
	const docUrl = 'https://www.docutrain.io/app/chat?doc=smh&footer=false';

	window.addEventListener('message', function(event) {
		// Verify origin for security
		if (event.origin !== 'https://www.docutrain.io') return;
		
		if (event.data.type === 'headerCollapsed') {
			// Could add parent-level handling here if needed
			console.log('Header collapsed state:', event.data.collapsed);
		}
	});

	// Initialize modal handlers - run immediately
	(function initModalHandlers() {
		function attachHandlers() {
			// Prevent closing when clicking inside the panel
			const modalPanel = document.querySelector('.modern-modal-panel');
			if (modalPanel) {
				modalPanel.addEventListener('click', function(e) {
					e.stopPropagation();
				});
			}
			
			// Add event listener to the chat button - use capture phase to catch early
			const chatButton = document.getElementById('open-chat-button');
			if (chatButton) {
				// Remove any existing handlers first by cloning
				const newButton = chatButton.cloneNode(false); // false = don't clone children/attributes
				// Copy the innerHTML
				newButton.innerHTML = chatButton.innerHTML;
				// Copy important attributes
				newButton.id = chatButton.id;
				newButton.className = chatButton.className;
				newButton.type = chatButton.type;
				chatButton.parentNode.replaceChild(newButton, chatButton);
				
				// Single unified handler for all pointer events (mouse, touch, pen)
				function handleButtonInteraction(e) {
					console.log('Button interaction:', e.type);
					e.preventDefault();
					e.stopPropagation();
					e.stopImmediatePropagation();
					openChatModal(e);
					return false;
				}
				
				// Handle all pointer event types the same way
				newButton.addEventListener('click', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('touchstart', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('touchend', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('pointerdown', handleButtonInteraction, { capture: true, passive: false });
				newButton.addEventListener('pointerup', handleButtonInteraction, { capture: true, passive: false });
			}
		}
		
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', attachHandlers);
		} else {
			attachHandlers();
		}
	})();

	function openChatModal(event) {
		console.log('openChatModal called', event);
		
		// Prevent multiple simultaneous calls
		if (isOpeningModal || chatModalOpen) {
			console.log('Modal already opening or open, ignoring duplicate call');
			return false;
		}
		
		// Prevent any default behavior FIRST - be very aggressive
		if (event) {
			event.preventDefault();
			event.stopPropagation();
			event.stopImmediatePropagation();
		}
		
		// Also prevent window navigation
		if (window.event) {
			window.event.preventDefault();
			window.event.stopPropagation();
		}
		
		isOpeningModal = true;
		
		const modal = document.getElementById('manual-assistant-modal');
		const iframe = document.getElementById('chat-iframe');
		const body = document.body;
		
		if (!modal || !iframe) {
			console.error('Modal elements not found');
			isOpeningModal = false;
			return false;
		}
		
		console.log('Opening modal');
		
		// Show modal IMMEDIATELY - don't wait for iframe
		modal.style.display = 'block';
		modal.style.visibility = 'visible';
		modal.style.opacity = '1';
		modal.style.zIndex = '99999'; // Ensure it's on top
		body.classList.add('modern-modal-open');
		chatModalOpen = true;
		preventScroll();
		
		// Force modal to be visible immediately
		requestAnimationFrame(() => {
			modal.classList.add('active');
			// Double-check modal is visible
			if (modal.style.display !== 'block') {
				modal.style.display = 'block';
			}
			if (!modal.classList.contains('active')) {
				modal.classList.add('active');
			}
		});
		
		// Set iframe src AFTER modal is visible
		iframe.src = 'about:blank';
		
		// Use a tiny delay to ensure about:blank is set, then set the actual URL
		setTimeout(() => {
			iframe.src = docUrl;
			isOpeningModal = false; // Reset guard after modal is shown
			
			// Verify modal is actually visible
			setTimeout(() => {
				const computedStyle = window.getComputedStyle(modal);
				console.log('Modal visibility check:', {
					display: computedStyle.display,
					visibility: computedStyle.visibility,
					opacity: computedStyle.opacity,
					zIndex: computedStyle.zIndex,
					hasActiveClass: modal.classList.contains('active')
				});
				
				if (computedStyle.display === 'none' || computedStyle.visibility === 'hidden') {
					console.warn('Modal not visible! Forcing visibility...');
					modal.style.display = 'block';
					modal.style.visibility = 'visible';
					modal.style.opacity = '1';
					modal.classList.add('active');
				}
			}, 100);
		}, 10);
		
		return false;
	}

	function closeChatModal() {
		const modal = document.getElementById('manual-assistant-modal');
		const iframe = document.getElementById('chat-iframe');
		const body = document.body;
		
		modal.classList.remove('active');
		body.classList.remove('modern-modal-open');
		chatModalOpen = false;
		
		// Reset iframe and hide modal after transition completes
		setTimeout(() => {
			iframe.src = 'about:blank';
			modal.style.display = 'none'; // Hide after transition
		}, 400);
		
		allowScroll();
	}

	let scrollPosition = 0;
	
	function preventScroll() {
		scrollPosition = window.pageYOffset;
		document.body.style.overflow = 'hidden';
		document.body.style.position = 'fixed';
		document.body.style.top = `-${scrollPosition}px`;
		document.body.style.width = '100%';
	}
	
	function allowScroll() {
		document.body.style.overflow = '';
		document.body.style.position = '';
		document.body.style.top = '';
		document.body.style.width = '';
		window.scrollTo(0, scrollPosition);
	}

	document.addEventListener('keydown', function(e) {
		if (e.key === 'Escape' && chatModalOpen) {
			closeChatModal();
		}
	});
</script>

<style>
	/* Two Options Side by Side */
	.manual-options {
		display: grid;
		grid-template-columns: 1fr;
		gap: 20px;
		margin: 40px 0;
	}
	
	@media (min-width: 768px) {
		.manual-options {
			grid-template-columns: 1fr 1fr;
			max-width: 100%;
		}
	}
	
	.option-card {
		background: #f9f9f9;
		border: 2px solid #e5e5e5;
		border-radius: 12px;
		padding: 40px 30px;
		text-align: center;
		transition: all 0.3s ease;
	}
	
	.option-card:hover {
		border-color: #cc0000;
		box-shadow: 0 4px 12px rgba(204, 0, 0, 0.15);
		transform: translateY(-2px);
	}
	
	.option-icon {
		font-size: 48px;
		color: #cc0000;
		margin-bottom: 20px;
	}
	
	.option-card h3 {
		font-size: 24px;
		margin: 0 0 10px 0;
		color: #333;
	}
	
	.option-card p {
		color: #666;
		margin-bottom: 25px;
		font-size: 16px;
	}
	
	.option-card .uk-button {
		padding: 8px 20px;
		font-size: 14px;
		text-decoration: none !important;
		cursor: pointer;
	}
	
	#open-chat-button {
		text-decoration: none !important;
		cursor: pointer;
		pointer-events: auto;
	}
	
	#open-chat-button:hover,
	#open-chat-button:active,
	#open-chat-button:focus {
		text-decoration: none !important;
		outline: none;
	}
	
	
	/* ===== PDF MODAL STYLES (unchanged) ===== */
	.uk-modal-close-full {
		bottom: 0 !important;
		left: 0;
		width: 50px;
		height: 50px;
		top: auto;
		z-index: 1000;
	}

	.uk-close {
		color: #ffffff;
		background: #cc0000 !important;
	}

	.uk-close:hover {
		color: pink;
	}

	.uk-modal-container {
		padding-top: 0;
	}

	.uk-modal.uk-open {
		overflow: hidden;
	}
	
	/* Prevent body scroll when UIKit modal is open */
	body.uk-modal-page {
		overflow: hidden;
	}

	/* Modern Modal Styles */
	.modern-modal-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		width: 100%;
		height: 100%;
		z-index: 99999 !important; /* Ensure highest z-index */
		opacity: 0;
		visibility: hidden;
		pointer-events: none;
		display: none; /* Completely hidden on page load */
		/* No transition on initial load - only when opening */
		transition: none;
	}

	.modern-modal-overlay.active {
		display: block; /* Show when active */
		opacity: 1;
		visibility: visible;
		pointer-events: all;
		/* Enable transition only when active */
		transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.4s;
	}

	.modern-modal-backdrop {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.6);
		backdrop-filter: blur(12px);
		-webkit-backdrop-filter: blur(12px);
		opacity: 0;
		/* Transition enabled for closing animation */
		transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.modern-modal-overlay.active .modern-modal-backdrop {
		opacity: 1;
	}

	.modern-modal-panel {
		position: absolute;
		top: 0;
		right: 0;
		width: 100%;
		height: 100%;
		background: #ffffff;
		box-shadow: -8px 0 32px rgba(0, 0, 0, 0.15);
		display: flex;
		flex-direction: column;
		transform: translateX(100%);
		/* Transition enabled for closing animation */
		transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		overflow: hidden;
		position: relative;
	}

	.modern-modal-overlay.active .modern-modal-panel {
		transform: translateX(0);
		/* Enable transition only when active */
		transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.modern-close-button {
		position: absolute;
		top: 20px;
		right: 20px;
		width: 44px;
		height: 44px;
		background: rgba(255, 255, 255, 0.95);
		border: 1px solid rgba(0, 0, 0, 0.1);
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		color: #333;
		transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		padding: 0;
		backdrop-filter: blur(10px);
		-webkit-backdrop-filter: blur(10px);
		z-index: 10000;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.modern-close-button:hover {
		background: rgba(255, 255, 255, 1);
		border-color: rgba(0, 0, 0, 0.2);
		transform: scale(1.05) rotate(90deg);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}

	.modern-close-button:active {
		transform: scale(0.95) rotate(90deg);
	}

	.modern-modal-body {
		flex: 1;
		overflow: hidden;
		position: relative;
		background: #ffffff;
	}

	.modern-iframe {
		width: 100%;
		height: 100%;
		border: none;
		display: block;
		opacity: 0;
		visibility: hidden;
		transition: opacity 0.3s ease 0.2s, visibility 0s 0.5s;
	}

	.modern-modal-overlay.active .modern-iframe {
		opacity: 1;
		visibility: visible;
		transition: opacity 0.3s ease 0.2s, visibility 0s 0s;
	}

	body.modern-modal-open {
		overflow: hidden;
	}

	/* Responsive Modal */
	@media (max-width: 768px) {
		.modern-close-button {
			top: 16px;
			right: 16px;
			width: 40px;
			height: 40px;
		}
	}
</style>